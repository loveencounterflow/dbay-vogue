{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/server.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'DBAY-VOGUE/SERVER'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\n( require 'mixa/lib/check-package-versions' ) require '../pinned-package-versions.json'\nPATH                      = require 'path'\nHTTP                      = require 'http'\nGUY                       = require 'guy'\nKoa                       = require 'koa'\nRouter                    = require '@koa/router'\n{ Server: Socket_server } = require 'socket.io'\nfile_server               = require 'koa-files'\nmount                     = require 'koa-mount'\n_types                    = require './types'\n\n\n# #-----------------------------------------------------------------------------------------------------------\n# app.use ( ctx, next ) =>\n#   debug \"^dbay-vogue/server@1^ dt-1 before\"\n#   await next()\n#   debug \"^dbay-vogue/server@2^ dt-1 after\"\n#   rt = ctx.response.get 'X-Response-Time'\n#   help \"^dbay-vogue/server@3^ #{ctx.method} #{ctx.url}; dt: #{rt}\"\n#   help \"^dbay-vogue/server@4^\", ctx.state\n#   return null\n# #...........................................................................................................\n# app.use ( ctx, next ) =>\n#   debug \"^dbay-vogue/server@5^ dt-2 before\"\n#   start = Date.now()\n#   await next()\n#   debug \"^dbay-vogue/server@6^ dt-2 after\"\n#   ms    = Date.now() - start\n#   ctx.set 'X-Response-Time', \"#{ms} ms\"\n#   ( ctx.state.greetings ?= [] ).push \"helo from X-Response-Time setter\"\n#   return null\n\n\n\n\n\n\n\n#===========================================================================================================\nclass @Vogue_server\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    GUY.props.hide @, 'types',    _types.types\n    GUY.props.hide @, 'defaults', _types.defaults\n    #.......................................................................................................\n    @cfg        = { @defaults.vogue_server_constructor_cfg..., cfg..., }\n    @types.validate.vogue_server_constructor_cfg @cfg\n    { client, } = GUY.obj.pluck_with_fallback @cfg, null, 'client'\n    @cfg        = GUY.lft.freeze @cfg\n    #.......................................................................................................\n    GUY.props.hide @, 'client', client\n    GUY.props.hide @, 'app',    new Koa()\n    GUY.props.hide @, 'router', new Router()\n    #.......................................................................................................\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  start: => new Promise ( resolve, reject ) =>\n    { host\n      port  } = @cfg\n    @_create_app()\n    #.......................................................................................................\n    GUY.props.hide @, 'http_server',  HTTP.createServer @app.callback()\n    GUY.props.hide @, 'io',           new Socket_server @http_server\n    #.......................................................................................................\n    @io.on 'connection', ( socket ) =>\n      help \"^dbay-vogue/server@8^ user connected to socket\"\n      return null\n    #.......................................................................................................\n    @http_server.listen { host, port, }, ->\n      debug \"^dbay-vogue/server@9^ listening\"\n      resolve { host, port, }\n    #.......................................................................................................\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_app: =>\n    @app.use                                  @_s_log\n    #.......................................................................................................\n    @router.get   'home',       '/',          @_r_home\n    @router.get   'trends',     '/trends',    @_r_trends\n    #.......................................................................................................\n    @app.use @router.routes()\n    #.......................................................................................................\n    ### thx to https://stackoverflow.com/a/66377342/7568091 ###\n    debug '^4345^', @cfg.paths.public\n    debug '^4345^', @cfg.file_server\n    @app.use mount '/public', file_server @cfg.paths.public, @cfg.file_server\n    #.......................................................................................................\n    @app.use @_s_default\n    @app.use @router.allowedMethods()\n    return null\n\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  _s_log: ( ctx, next ) =>\n    await next()\n    # { method\n    #   url\n    #   originalUrl\n    #   origin\n    #   href\n    #   path\n    #   query\n    #   querystring\n    #   host\n    #   hostname\n    #   protocol }  = ctx\n    querystring   = if ctx.querystring?.length > 1 then \"?#{ctx.querystring}\" else ''\n    # help \"^dbay-vogue/server@7^\", { method, url, originalUrl, origin, href, path, query, querystring, host, hostname, protocol, }\n    color = if ctx.status < 400 then 'lime' else 'red'\n    line  = \"#{ctx.method} #{ctx.origin}#{ctx.path}#{querystring} -> #{ctx.status} #{ctx.message}\"\n    echo ( CND.grey \"^dbay-vogue/server@7^\" ), ( CND[ color ] line )\n    # warn \"^dbay-vogue/server@7^\", \"#{ctx.status} #{ctx.message}\"\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _r_home: ( ctx ) =>\n    ctx.body = \"DBay Vogue App\"\n    # help \"^dbay-vogue/server@7^\", ctx.router.url 'home', { query: { foo: 'bar', }, }\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _r_trends: ( ctx ) =>\n    urge \"^dbay-vogue/server@7^\", ctx.router.url 'trends', { query: { foo: 'bar', }, }\n    debug '^34346^', @client\n    R = []\n    R.push \"<!DOCTYPE html>\"\n    R.push \"\"\"\n      <script src='/public/d3@7.js'></script>\n      <script src='/public/plot@0.4.js'></script>\n      <style>\n        td {\n          background-color: #ddd;\n          white-space: nowrap; }\n      </style>\"\"\"\n    R.push \"<h3>DBay Vogue App / Trends</h3>\"\n    R.push \"<table>\"\n    for row from @client.scr.db \"\"\"select * from scr_trends_html order by sid desc, nr desc;\"\"\"\n      R.push row.html\n    R.push \"</table>\"\n    #.......................................................................................................\n    ctx.response.type   = 'html'\n    ctx.body            = R.join '\\n'\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _s_default: ( ctx ) =>\n    ctx.response.status = 404\n    ctx.response.type   = 'html'\n    ctx.body            = \"\"\"<!DOCTYPE html>\n      <h3>DBay Vogue App / 404 / Not Found</h3>\n      \"\"\"\n    # ctx.throw 404, \"no content under #{ctx.url}\"\n    # ( ctx.state.greetings ?= [] ).push \"helo from content handler\"\n    return null\n"
  ]
}